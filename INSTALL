#!/bin/bash

# Vérification des privilèges root
if [ "$EUID" -ne 0 ]; then
    echo "Erreur : Ce script doit être exécuté en tant que root (utilisez sudo)"
    exit 1
fi

# Mise à jour des paquets et installation des dépendances
echo "Installation des dépendances..."
apt update -y
apt install -y jq trickle inotify-tools autossh sshpass netcat-openbsd curl || {
    echo "Erreur : Échec de l'installation des dépendances"
    exit 1
}

# Création des répertoires nécessaires
echo "Création des répertoires..."
mkdir -p /etc/sshtunnel/conf.d
mkdir -p /var/log/sshtunnel
mkdir -p /var/run/sshtunnel
mkdir -p /root/.ssh
chmod 750 /etc/sshtunnel /etc/sshtunnel/conf.d /var/log/sshtunnel /var/run/sshtunnel
chmod 700 /root/.ssh
chown root:root /etc/sshtunnel /etc/sshtunnel/conf.d /var/log/sshtunnel /var/run/sshtunnel /root/.ssh

# Copie du script principal
echo "Installation du script principal..."
if [ -f ./sshtunnel-manager ]; then
    cp ./sshtunnel-manager /usr/local/bin/sshtunnel-manager
    chmod 755 /usr/local/bin/sshtunnel-manager
else
    echo "Erreur : Le fichier sshtunnel-manager est introuvable dans le répertoire courant"
    exit 1
fi

# Copie du fichier de service systemd
echo "Configuration du service systemd..."
if [ -f ./sshtunnel-manager.service ]; then
    cp ./sshtunnel-manager.service /etc/systemd/system/sshtunnel-manager.service
    chmod 644 /etc/systemd/system/sshtunnel-manager.service
else
    echo "Erreur : Le fichier sshtunnel-manager.service est introuvable dans le répertoire courant"
    exit 1
fi

# Copie des fichiers de complétion Bash (si présents)
if [ -f ./sshtunnel.completions ]; then
    echo "Installation de la complétion Bash..."
    cp ./sshtunnel.completions /etc/bash_completion.d/sshtunnel-manager
    chmod 644 /etc/bash_completion.d/sshtunnel-manager
fi

# Copie des fichiers de configuration (si présents dans conf.d/)
if [ -d ./conf.d ] && [ -n "$(ls -A ./conf.d)" ]; then
    echo "Copie des fichiers de configuration..."
    cp ./conf.d/*.json /etc/sshtunnel/conf.d/ 2>/dev/null || true
    chmod 640 /etc/sshtunnel/conf.d/*.json
    chown root:root /etc/sshtunnel/conf.d/*.json
fi

# Rechargement de systemd et activation du service
echo "Activation du service..."
systemctl daemon-reload
systemctl enable sshtunnel-manager.service

echo "============= Installation terminée avec succès ! ============="
echo "Les fichiers de configuration sont dans /etc/sshtunnel/conf.d/"
echo "Pour démarrer le service immédiatement :"
echo "  sudo systemctl start sshtunnel-manager.service"
echo "Pour vérifier l'état du service :"
echo "  sudo systemctl status sshtunnel-manager.service"